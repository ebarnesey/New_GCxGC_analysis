---
title: "mdom_timelines"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libs, message = FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)

library(scales)

library(akima)
#library(asbio)
#library(tmap)         # raster + vector layers
#library(raster)       # Main raster library
#library(tidyverse)    # our old friend
#library(sf)           # to work with simple features data
#library(mapview)
library(openxlsx)
library(class)
library(RANN)
library("survival")
library("Hmisc")

library(MARSS)
library(utils)


#install.packages("survival")

library(lattice)
#install.packages("latticeExtra")


library(survival)
library(Hmisc)
library(lubridate)
#install.packages("installr")
#library(installr)
```
## R Markdown

```{r timeline_import, message=FALSE, warning=FALSE}
bt_sum_mdom <- read_csv("Blob_table_summary_CAICEmdom.csv") %>% 
  filter(!is.na(File_num))
  


bt_sum_mdom <- bt_sum_mdom %>% mutate(r_date =    mdy_hm(SS_startdate)) %>% 
  mutate(run_date = as.Date(gsub("GCxGC_","",File_num), "%Y%m%d"))

make_file_name <- function(date_string) {
  file_start <- "MDOM_blobtables/"
  file_end <- ".csv"
  full_name <- paste(file_start,date_string,file_end, sep = "")
  return(full_name)
  
}

read_bt_files <- function(fi_name_short) {
  
  fi_name <- make_file_name(fi_name_short)
  temp_bt <<- read_csv(file = fi_name)
  temp_bt <- temp_bt %>% mutate(File_num = fi_name_short)
  temp_bt <<- temp_bt
  return(temp_bt)
}

make_massive_table <- function(summary_table){
 
  M <- read_bt_files(as.character(summary_table$File_num[1]))

  for(i in 2:length(summary_table$File_num)){
    t <- read_bt_files(as.character(summary_table$File_num[i]))
    Mnew <- rbind(M, t)
    M <- Mnew
    print(i)
  }
  M_t <<- M
}

make_massive_table(bt_sum_mdom)


M_t_full_mdom <- M_t %>% 
  left_join(bt_sum_mdom, by = "File_num") 

names(M_t_full_mdom) <- make.names(names(M_t_full),unique = TRUE) 



```

```{r, message=FALSE, warning=FALSE}
Match_factor_floor <- 750
Reverse_match_factor_floor <- 100
LRI_diff_floor <- 6




fb_match_factor_floor <- 600
fb_reverse_match_factor_floor <- 100
IS_lib_name <- "caice_ssi"
# lib_remove_1 <- "caice_ssa_0805_0612"
# lib_remove_2 <- "caice_ssa_0803_1728"
# lib_remove_3 <- "caice_ssa_0803_oil_1728"
# lib_remove_4 <- "amzi0503_b"
FB_lib_name <- "caice_mdom_meohblank_nottraced"

rt2_floor <- .15 # note: check on this, but for purposes of indexing retention times in 2d this is important

# creating a column of the differences in linear retention indecies so that poor matches can be screened out
M_t_LRI_mdom <- M_t_full_mdom %>% mutate(LRI_diff = abs(Library.RI-LRI.I)) %>% 
  mutate(LRI_diff = replace_na(LRI_diff, -999))


# # getting rid of things that should be removed
# remove_match <- M_t_LRI %>% 
#   filter(Library.Name == lib_remove_1 | Library.Name == lib_remove_2 | Library.Name == lib_remove_3 | Library.Name == lib_remove_4)


# identifying the internal standard
IS_goodmatch_mdom <- M_t_LRI_mdom %>% 
  filter(Library.Name == IS_lib_name | Library.Name == "-") %>% 
  filter(LRI_diff < LRI_diff_floor | Description== "match") %>% 
  filter(Library.Match.Factor > Match_factor_floor| Description== "match")  

FB_goodmatch <- M_t_LRI_mdom %>%
  filter(Library.Name == FB_lib_name) %>%
  filter(LRI_diff < LRI_diff_floor) %>%
  filter(Library.Match.Factor > fb_match_factor_floor)

FB_okmatch <- M_t_LRI_mdom %>%
  filter(Library.Name == FB_lib_name) %>%
  filter(Library.Match.Factor> fb_match_factor_floor-100) %>%
  anti_join(FB_goodmatch)
  
IS_okmatch <- M_t_LRI_mdom %>% 
  filter(Library.Name == IS_lib_name | Library.Name == "-") %>%
  filter(Library.Match.Factor > Match_factor_floor-100)  %>% 
  anti_join(IS_goodmatch_mdom)

small_poorlymatched <- M_t_LRI_mdom %>% 
  filter(Library.Match.Factor < Match_factor_floor) %>% 
  filter(Volume < 200)

btz4 <- small_poorlymatched %>% 
  filter(Compound.Name == "20200803_1535_blob_958_")
# 33/70 in here, makes sense

M_t_all_analytes <- M_t_LRI_mdom %>% 
  #anti_join(FB_goodmatch) %>% 
  anti_join(IS_goodmatch_mdom) %>% 
  #anti_join(FB_okmatch) %>% 
  anti_join(IS_okmatch) %>% 
  anti_join(remove_match) %>% 
  anti_join(small_poorlymatched) %>% 
  filter(LRI.I > 1200) 



## Getting rid of things that existed and were well matched in the tap water blank

  
M_t_analyte_unique_mdom <- M_t_all_analytes %>% 
  arrange((r_date)) %>% 
  filter(Library.Name != IS_lib_name) %>% 
  filter(LRI_diff < LRI_diff_floor| Description == "match") %>% 
  filter(Library.Match.Factor > Match_factor_floor | Description == "match") %>% 
  #filter(Library.Reverse.Match.Factor > Reverse_match_factor_floor) %>% 
  arrange(desc(Volume)) %>% 
  arrange(Compound.Name) %>% 
  arrange(r_date) %>% 
  distinct(Compound.Name, r_date, .keep_all = TRUE)
```



```{r}

# tracking the mass of all of the analytes before bad matches are screened out for later analysis of library performance
M_t_all_analytes_volcount <- M_t_all_analytes %>% 
  group_by(File_num) %>% 
  summarise(rawvol = sum(Volume))

# tracking the number of all analutes in
M_t_all_analytes_ncount <- M_t_all_analytes %>% 
  count(File_num) %>% 
  dplyr::rename(total_num_analyte = n)

M_t_match_analytes_volcount <- M_t_analyte_unique_mdom %>% 
  group_by(File_num) %>% 
  summarise(rawvol_match = sum(Volume))

M_t_match_analytes_ncount <- M_t_analyte_unique_mdom %>% 
  count(File_num) %>% 
  dplyr::rename(total_num_analyte_match = n)

M_t_analyte_summary <- M_t_all_analytes_volcount %>% 
  left_join(M_t_all_analytes_ncount) %>% 
  left_join(M_t_match_analytes_volcount) %>% 
  left_join(M_t_match_analytes_ncount) %>% 
  mutate(perct_nfound = (total_num_analyte_match/total_num_analyte)*100) %>% 
  mutate(perct_volfound = (rawvol_match/rawvol)*100)

compound_pop <- M_t_analyte_unique_mdom %>% 
  count(Compound.Name) %>% 
  dplyr::rename(comp.n = n) %>% 
  mutate(pct_of_samp = (comp.n/max(comp.n)*100))

#table(compound_pop$comp.n)
#hist(compound_pop$comp.n)

# 
# #note: potential issue with screening out bad fb matches eek
# M_t_analyte_count <- M_t_full %>%
#   filter(Library.Name != "amzi0503_b") %>%
#   filter(Library.Name != "fb_amz_compiled_t") %>%
#   count(File_num) %>%
#   rename(total_num_analyte = n)

M_t_analyte_count <- M_t_all_analytes %>% 
  count(File_num) %>%
  dplyr::rename(total_num_analyte = n)
# 
# # counting the number of unique analytes in each image
num_analyte_unique_mdom <- M_t_analyte_unique_mdom %>%
  count(File_num) %>%
  dplyr::rename(unique.analyte = n)

# counting the number based percent of compounds being traced in all 
perct_comps_traced <- num_analyte_unique_mdom %>% 
   left_join(M_t_analyte_count) %>% 
   mutate(pct_found = unique.analyte/total_num_analyte)
# 
#perct_comps_traced %>%
#  ggplot(aes(y = pct_found))+
#  geom_boxplot()

summary(perct_comps_traced$pct_found)


M_t_analyte_unique_mdom <- M_t_analyte_unique_mdom %>% left_join(num_analyte_unique)

compound_pop <- M_t_analyte_unique_mdom %>% 
  count(Compound.Name) %>% 
  dplyr::rename(comp.n = n) %>% 
  mutate(pct_of_samp = (comp.n/max(comp.n)*100))

table(compound_pop$comp.n)

hist(compound_pop$pct_of_samp, 
     main = paste("Histogram of", nrow(compound_pop), "Traced Compounds\nOver Seascape Bloom 3"),
     xlab = "Percent Occurence Above Detection Limits",
     col = "grey")

MDOM_sample_cumsum <- M_t_analyte_unique_mdom %>% 
  group_by(File_num) %>% 
  summarise(File_vol = sum(Volume))


M_t_analyte_unique_mdom <- M_t_analyte_unique_mdom %>% 
  left_join(compound_pop) %>% 
  left_join(MDOM_sample_cumsum) %>% 
  mutate(Volume_Fraction = Volume/File_vol)


M_t_analyte_unique_mdom %>% 
  mutate(char_comp_n = as.integer(round(pct_of_samp, 0))) %>% 
  group_by(char_comp_n) %>% 
  summarise(avg_vol_byn = mean(Volume)) %>% 
  ggplot(aes(x = char_comp_n, y = avg_vol_byn)) +
  geom_col()+
  labs(title = "Average Blob Volume by Library Match Frequency")+
  xlab("Percent of Samples with Positive Library Match")+
  ylab("Average Blob Volume")

```

```{r fig.width=2, fig.height=3, warning = FALSE}


M_t_analyte_summary %>% 
  ggplot(aes(y = perct_nfound))+
  geom_boxplot(fill = "pink") + 
  theme_bw()+
  ylab("Percent of Analytes Assigned to \nLibrary Match")

M_t_analyte_summary %>% 
  ggplot(aes(y = perct_volfound))+
  geom_boxplot(fill = "pink") + 
  theme_bw()+
  ylab("Percent of Analyte Volume Assigned to \nLibrary Match")

summary(M_t_analyte_summary$perct_volfound)

```

```{r}

unique_tracing <- M_t_analyte_unique_mdom %>% 
  arrange(r_date)

unique_tag <- 
  unique_tracing %>% 
  filter(File_num == bt_sum_mdom$File_num[1]) %>% 
  mutate(is_unique_prior = NA) %>% 
  dplyr::select(Compound.Name, File_num, is_unique_prior)


for(i in 2:nrow(bt_sum_mdom)){
  
  
  
  previous_file_i <- bt_sum_mdom$File_num[i-1]
  file_i <- bt_sum_mdom$File_num[i]
  
  prev_compounds <- unique_tracing %>% 
    filter(File_num == previous_file_i) %>% 
    mutate(is_unique_prior = FALSE) %>% 
    dplyr::select(Compound.Name, is_unique_prior)
  
  compounds_i <- unique_tracing %>% 
    filter(File_num== file_i)
  
  
  unique_tag_t <- compounds_i %>% 
    left_join(prev_compounds, by = "Compound.Name") %>% 
    dplyr::select(Compound.Name, File_num, is_unique_prior)
  
  unique_tag <- rbind(unique_tag, unique_tag_t)
    
  
}

unique_tracing_c <- unique_tracing %>% 
  left_join(unique_tag, by = c("Compound.Name", "File_num")) %>% 
  mutate(unique_log = is.na(is_unique_prior)) %>% 
  mutate(unique_vol = unique_log * Volume) 


avg_unique = sum(unique_tracing_c$unique_vol)/sum(unique_tracing_c$Volume)

```

```{r}
unique_tracing_c %>% 
  #filter(IOP == 2) %>% 
  mutate(ones = 1) %>% 
  ggplot(aes(fill = unique_log, y = ones, x = r_date))+
  geom_bar(position = "stack", stat = "identity")+
  ylab("Analyte Count")




unique_tracing_c %>% 
  #filter(IOP == 2) %>% 
  mutate(ones = 1) %>% 
  ggplot(aes(fill = unique_log, y = Volume, x = r_date))+
  geom_bar(position = "stack", stat = "identity")+
  ylab("Analyte Raw Volume")+
  xlab("Dry Season GoAmazon Date")+
  scale_fill_manual(name = "Unique Compared\n to Previous Sample", values=c("blue", "green"))+
  theme(axis.text.x = element_text(size=14), axis.text.y = element_text(size=14), axis.text=element_text(size=12),
        axis.title=element_text(size=14))


  
  
```
```{r pressure, importing chemical info}

compiled_comp_info_mdom <- read_csv("Compiled_Compoundinfo_Blobtable_SS_mdom.csv")

compiled_comp_info_mdom.findable <- compiled_comp_info_mdom %>% 
  filter(Library.Match.Factor_NISTmain> 800) %>% 
  mutate(Identifiable = TRUE) %>% 
  dplyr::select(Compound.Name, Identifiable)

#id.tags <- data.frame("Identifiable"= c(TRUE, NA), ID)

compiled_comp_info_mdom <- compiled_comp_info_mdom %>% 
  left_join(compiled_comp_info_mdom.findable) %>% 
  mutate(tic = 1)

compiled_comp_info_mdom %>% 
  ggplot(aes(x = "", y = tic, fill = Identifiable)) + 
  geom_col()+
  coord_polar("y", start = 0)+
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(fill = "",
       x = NULL,
       y = NULL) + 
  ggtitle("991 Novel and Identifiable Submicron SSA Compounds- SeaScape")

```


```{r}
mdom_cumsum_raw <- M_t_analyte_unique_mdom%>% 
  mutate(tic = 1) %>% 
  group_by(Compound.Name) %>% 
  summarise(raw_cumsum = sum(Volume), num_obs = sum(tic)) %>% 
  mutate(pct_obs = num_obs/nrow(bt_sum_mdom)) %>% 
  arrange(desc(raw_cumsum))





M_t_analyte_unique_mdom_info <- M_t_analyte_unique_mdom %>% 
  left_join(mdom_cumsum_raw, by = "Compound.Name") %>% 
  left_join(compiled_comp_info_mdom, by = "Compound.Name") %>% 
  left_join(compiled_comp_info_mdom.findable, by = "Compound.Name")

for(i in 1:nrow(compiled_comp_info_mdom.findable)){
  findable_c <- compiled_comp_info_mdom$Compound.Name[i]
  
  f1 <- M_t_analyte_unique_mdom_info %>% 
    filter(Compound.Name == findable_c) %>% 
    ggplot(aes(x = r_date, y = Volume, color = Compound.Name_NISTmain))+
    geom_line()
  
  print(f1)
  
  
  
  
}

```

```{r IS_mapping1}
# note: unlike sample analytes, internal standard compounds are frequently split vertically into multiple blobs because of the high volume.  In order to account for this, I am summing all blobs together that meet the high match criteria and are very close in the first dimension.
IS_unique_mdom <- IS_goodmatch_mdom %>% 
  group_by(Compound.Name, File_num) %>% 
  summarise(Volume_tot = sum(Volume)) %>% 
  filter(Compound.Name != "glucose-13C6") %>% 
  filter(Compound.Name != "dC14") %>% 
  filter(Compound.Name != "d-C22 acid, TMS") 


fixing <- data.frame(table(IS_unique_mdom$Compound.Name)) %>% 
  mutate(Compound.Name = Var1)

IS_tofix <- IS_unique_mdom %>% 
  left_join(fixing) %>% 
  filter(Freq < 8) %>% 
  left_join(bt_sum_mdom, by = "File_num")

IS_unique_c <- IS_unique %>% 
  mutate(tic = 1) %>% 
  group_by(File_num) %>% 
  summarise(ticsum = sum(tic))

c<- data.frame(table(IS_unique$Compound.Name))

# note: this is not knitting, not sure why but did temporary work around
IS_positions_mdom <- IS_goodmatch_mdom %>%
  filter(Compound.Name != "glucose-13C6") %>%
  filter(Compound.Name != "dC14") %>%
  group_by(Compound.Name, File_num) %>%
  #summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec.-rt2_floor))
  summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec. - rt2_floor))
# 
# IS_positions_knit <- write.csv(IS_positions, "IS.pos.knit.csv")

# IS_positions <- read.csv("IS.pos.knit.csv") %>% 
#   dplyr::select(-X)
#   

IS_avg_vols_toadd <- IS_unique_mdom %>% 
  group_by(Compound.Name) %>% 
  summarise(IS_avgvol = mean(Volume_tot), IS_medvol = median(Volume_tot)) %>% 
  left_join(IS_unique) %>% 
  mutate(IS_mean_norm = Volume_tot / IS_avgvol) %>%
  mutate(IS_med_norm = Volume_tot / IS_medvol) %>% 
  dplyr::select(Compound.Name, File_num, IS_mean_norm)

write.csv(IS_avg_vols_toadd, "IS_avg_vols_mdom.csv")

IS_unique_pos <- IS_unique_mdom %>% 
  left_join(IS_positions_mdom) %>% 
  left_join(IS_avg_vols_toadd)



# IS_test1 <- IS_unique_pos %>% 
#   filter(File_num == "GCxGC_20200803_1001")
# 
# IS_1_vol <- IS_test1$Volume_tot
# RI1 <- IS_test1$LRI_avg
# RI2 <- IS_test1$RI2

# IS_1_pos <- IS_test1 %>% 
#   ungroup() %>% 
#   dplyr::select("LRI_avg", "RI2")
# IS_positions_202008061332 <- read.csv("GCxGC_20200806_1332.h5_img01_IS_selected_positions_Blob_Table.csv")
# IS_rt2 <- IS_positions_202008061332 %>% 
#   dplyr::select(Compound.Name, Retention.II..sec.)

# IS_positions <- IS_goodmatch %>% 
#   filter(Compound.Name != "glucose-13C6") %>% 
#   filter(Compound.Name != "dC14") %>% 
#   group_by(Compound.Name, File_num) %>% 
#   #summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec.-rt2_floor))
#   summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec. - rt2_floor))


IS_positions_mdom_avg <- IS_positions_mdom %>% 
  group_by(Compound.Name) %>% 
  summarise(LRI_avg_all = mean(LRI_avg, na.rm = TRUE), Retention.II..sec. = mean(RI2, na.rm = TRUE)) 


write.csv(IS_positions_mdom_avg, "IS_positions_mdom_avg.csv")


IS_avg_vols_mdom <- IS_unique_mdom %>% 
  group_by(Compound.Name) %>% 
  summarise(IS_avgvol = mean(Volume_tot), IS_medvol = median(Volume_tot)) %>% 
  left_join(IS_unique_mdom) %>% 
  mutate(IS_mean_norm = Volume_tot / IS_avgvol) %>%
  mutate(IS_med_norm = Volume_tot / IS_medvol) %>% 
  left_join(bt_sum_mdom)

IS_cat <- read.csv("IS_withcat.csv")
IS_cat <- IS_cat %>% 
  dplyr::select(-X)

IS_avg_vols_mdom <- IS_avg_vols_mdom %>% 
  left_join(IS_cat)
  

IS_just_one_IS <- IS_avg_vols_mdom %>% 
  filter(Compound.Name == "dC24") %>% 
  dplyr::select(File_num, dalk_norm=IS_mean_norm) 

IS_stability <- IS_avg_vols_mdom %>% 
  left_join(IS_just_one_IS) %>% 
  left_join(IS_positions_mdom_avg)

IS_stability %>% 
  ggplot(aes(x = dalk_norm, y = IS_mean_norm, color = F_group_cat))+
  geom_point()+
  ylim(0, 2) +
  xlim(0,2)
  



IS_avg_vols_mdom %>% ggplot(aes(x = r_date, y = IS_med_norm, color = Compound.Name)) +
  geom_point()
  

IS_avg_vols_mdom %>% ggplot(aes(x = r_date, y = Volume_tot, color = Compound.Name)) +
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = IS_mean_norm, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = Volume_tot, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = IS_mean_norm, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = Volume_tot, color = r_date))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = IS_mean_norm, color = F_group_cat))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = LRI_avg_all, y = Volume_tot, color = F_group_cat))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = IS_mean_norm, color = F_group_cat))+
  geom_point()

IS_stability %>% 
  ggplot(aes(x = Retention.II..sec., y = Volume_tot, color = F_group_cat))+
  geom_point()
```


```{r IS_mapping2}
LRI_weight = 2
LRII_weight = 1

LRI1_avg = mean(IS_positions_mdom_avg$LRI_avg_all, na.rm = TRUE)
LRI2_avg = mean(IS_positions_mdom_avg$Retention.II..sec.)

IS_positions_mdom_avg <- IS_positions_mdom_avg %>% 
  mutate(relative_LRI = (LRI_avg_all/LRI1_avg)*LRI_weight) %>% 
  mutate(relative_LRI2 = (Retention.II..sec./LRI2_avg)*LRII_weight)

write.csv(IS_positions_mdom_avg, "IS_positions_mdom_avg_rel.csv")

Analyte_positions_mdom_trial <- M_t_analyte_unique_mdom %>% 
  group_by(Compound.Name, File_num) %>% 
  summarise(LRI_avg = mean(LRI.I), RI2 = min(Retention.II..sec. - rt2_floor))

# note filtering out three small blobs outside of RI window

Analyte_positions_mdom <- M_t_analyte_unique_mdom %>% 
  filter(!is.na(LRI.I)) %>% 
  group_by(Compound.Name) %>% 
  summarise(LRI_avg = mean(LRI.I, na.rm = TRUE), RI2 = (mean(Retention.II..sec.) - rt2_floor))

Analyte_positions_mdom <- Analyte_positions_mdom %>% 
  mutate(relative_LRI = (LRI_avg/LRI1_avg)*LRI_weight) %>% 
  mutate(relative_LRI2 = (RI2/LRI2_avg)*LRII_weight)

# checking to make sure that the ranges match up, eg back end checking that same norm method used on moth IS and analyte positions
summary(IS_positions_mdom_avg$relative_LRI)
summary(Analyte_positions_mdom$relative_LRI)
summary(IS_positions_mdom_avg$relative_LRI2)
summary(Analyte_positions_mdom$relative_LRI2)

Analyte_pos_mdom_short <- Analyte_positions_mdom %>% 
  dplyr::select(relative_LRI, relative_LRI2)

IS_pos_mdom_short <- IS_positions_mdom_avg %>% 
  dplyr::select(relative_LRI, relative_LRI2)

#knn(IS_pos_short, Analyte_pos_short, cl=IS_pos_short$Compound.Name, k=1, l=0)

#Old method, only using 1 nearest
#testnn <- nn2(IS_pos_short, query = Analyte_pos_short, treetype = "kd", searchtype = "standard", k=1)

# note 1.19 is the min radius at which every compound has at least one nearest
testnn <- nn2(IS_pos_mdom_short, query = Analyte_pos_mdom_short, treetype = "kd", searchtype = "radius", k=3, radius = 3.9)


Analyte_IS_Index <- data.frame(testnn$nn.idx)
# old method only using 1 nearest
# Analyte_pos_ad <- data.frame(Compound.Name = Analyte_positions$Compound.Name, IS_index = Analyte_IS_Index)

Analyte_pos_ad <- data.frame(Compound.Name = Analyte_positions_mdom$Compound.Name, IS_index1 = Analyte_IS_Index$X1, IS_index2 = Analyte_IS_Index$X2, IS_index3 = Analyte_IS_Index$X3)

# old method with only 1 IS
# Analyte_with_IS <- Analyte_pos_ad %>% 
#   mutate(IS_appropriate = IS_positions_avg$Compound.Name[IS_index])

# Analyte_with_IS <- Analyte_pos_ad %>% 
#   mutate(IS_appropriate1 = IS_positions_avg$Compound.Name[IS_index1]) %>% 
#   mutate(IS_appropriate2 = IS_positions_avg$Compound.Name[IS_index2]) %>% 
#   mutate(IS_appropriate3 = IS_positions_avg$Compound.Name[IS_index3])

Analyte_with_IS_mdom <- Analyte_pos_ad %>% 
  mutate(IS_appropriate1 = NA) %>% 
  mutate(IS_appropriate2 = NA) %>% 
  mutate(IS_appropriate3 = NA)

for(i in 1:nrow(Analyte_with_IS_mdom)){
  t_isind_1 <- Analyte_with_IS_mdom$IS_index1[i]
  t_isind_2 <- Analyte_with_IS_mdom$IS_index2[i]
  t_isind_3 <- Analyte_with_IS_mdom$IS_index3[i]
  
  if(t_isind_1 > 0){
  t_isap_1 <- IS_positions_mdom_avg$Compound.Name[t_isind_1]
  }else{
    t_isap_1 <- NA
  }
  
  if(t_isind_2 > 0){
  t_isap_2 <- IS_positions_mdom_avg$Compound.Name[t_isind_2]
  }else{
    t_isap_2 <- NA
  }
  
  if(t_isind_3 > 0){
  t_isap_3 <- IS_positions_mdom_avg$Compound.Name[t_isind_3]
  }else{
    t_isap_3 <- NA
  }
  
  
  
  Analyte_with_IS_mdom$IS_appropriate1[i] <- t_isap_1
  Analyte_with_IS_mdom$IS_appropriate2[i] <- t_isap_2
  Analyte_with_IS_mdom$IS_appropriate3[i] <- t_isap_3
  
}

# Analyte_with_IS_positions <- Analyte_with_IS %>% 
#   left_join(Analyte_positions) %>% 
#   left_join(IS_positions_avg, by = c("IS_appropriate"= "Compound.Name"))

Analyte_with_IS_positions_mdom <- Analyte_with_IS_mdom %>% 
  left_join(Analyte_positions_mdom) %>% 
  left_join(IS_positions_mdom_avg, by = c("IS_appropriate1"= "Compound.Name")) %>% 
  left_join(IS_positions_mdom_avg, by = c("IS_appropriate2"= "Compound.Name")) %>% 
  left_join(IS_positions_mdom_avg, by = c("IS_appropriate3"= "Compound.Name"))

M_t_analyte_withIS_mdom <- M_t_analyte_unique_mdom %>% 
  left_join(Analyte_with_IS_mdom) %>% 
  mutate(IS_vol1= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm1= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_vol2= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm2= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_vol3= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm3= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_vol_dalk= -999*(LRI.I/LRI.I)) %>% 
  mutate(IS_mean_norm_dalk= -999*(LRI.I/LRI.I))

# old- only 1 IS
# M_t_analyte_withIS <- M_t_analyte_unique %>% 
#   left_join(Analyte_with_IS) %>% 
#   mutate(IS_vol= -999*(LRI.I/LRI.I)) %>% 
#   mutate(IS_mean_norm= -999*(LRI.I/LRI.I)) 


# for(i in 1:nrow(M_t_analyte_withIS)){
#   
#   
#   IS_name = M_t_analyte_withIS$IS_appropriate[i]
#   File_num_t = M_t_analyte_withIS$File_num[i]
#   
#   IS_indicated <- IS_stability %>% 
#     filter(Compound.Name == IS_name) %>% 
#     filter(File_num == File_num_t)
#   
#   M_t_analyte_withIS$IS_vol[i] <-IS_indicated$Volume_tot[1]
#   M_t_analyte_withIS$IS_mean_norm[i] <-IS_indicated$IS_mean_norm[1]
#   
#   
# }

for(i in 1:nrow(M_t_analyte_withIS_mdom)){
  
  
  
  IS_name1 = M_t_analyte_withIS_mdom$IS_appropriate1[i]
  IS_name2 = M_t_analyte_withIS_mdom$IS_appropriate2[i]
  IS_name3 = M_t_analyte_withIS_mdom$IS_appropriate3[i]
  
  
  
  
  File_num_t = M_t_analyte_withIS_mdom$File_num[i]
  
  IS_indicated1 <- IS_stability %>% 
    filter(Compound.Name == IS_name1) %>% 
    filter(File_num == File_num_t)
  
  M_t_analyte_withIS_mdom$IS_vol1[i] <-IS_indicated1$Volume_tot[1]
  M_t_analyte_withIS_mdom$IS_mean_norm1[i] <-IS_indicated1$IS_mean_norm[1]
  
  IS_indicated2 <- IS_stability %>% 
    filter(Compound.Name == IS_name2) %>% 
    filter(File_num == File_num_t)
  
  M_t_analyte_withIS_mdom$IS_vol2[i] <-IS_indicated2$Volume_tot[1]
  M_t_analyte_withIS_mdom$IS_mean_norm2[i] <-IS_indicated2$IS_mean_norm[1]
  
  IS_indicated3 <- IS_stability %>% 
    filter(Compound.Name == IS_name3) %>% 
    filter(File_num == File_num_t)
  
  M_t_analyte_withIS_mdom$IS_vol3[i] <-IS_indicated3$Volume_tot[1]
  M_t_analyte_withIS_mdom$IS_mean_norm3[i] <-IS_indicated3$IS_mean_norm[1]
  
}

# 
# M_t_analyte_withIS <- M_t_analyte_withIS %>% 
#   mutate(vol_is_normnorm = Volume/IS_mean_norm) %>% 
#   mutate(vol_is_rawnorm = Volume/IS_vol)
#   

# note- this step is not working
# M_t_analyte_withIS <- M_t_analyte_withIS %>% 
#   mutate(IS_vol = mean(c(IS_vol1, IS_vol2, IS_vol3), na.rm = TRUE)) %>% 
#   mutate(IS_mean_norm = mean(c(IS_mean_norm1, IS_mean_norm2, IS_mean_norm3), na.rm = TRUE))

for(i in 1:nrow(M_t_analyte_withIS_mdom)){
  
  isvols_raw <- c(M_t_analyte_withIS_mdom$IS_vol1[i], M_t_analyte_withIS_mdom$IS_vol2[i], M_t_analyte_withIS_mdom$IS_vol3[i])
  
  M_t_analyte_withIS_mdom$IS_vol[i] = mean(isvols_raw, na.rm = TRUE)
  
  isvols_norm <- c(M_t_analyte_withIS_mdom$IS_mean_norm1[i], M_t_analyte_withIS_mdom$IS_mean_norm2[i], M_t_analyte_withIS_mdom$IS_mean_norm3[i])
  
  M_t_analyte_withIS_mdom$IS_mean_norm[i] = mean(isvols_norm, na.rm = TRUE)
  
}


M_t_analyte_withIS_mdom <- M_t_analyte_withIS_mdom %>% 
  mutate(vol_is_normnorm = Volume/IS_mean_norm) %>% 
  mutate(vol_is_rawnorm = Volume/IS_vol) 


IS_problems <- M_t_analyte_withIS_mdom %>% 
  filter(is.na(IS_appropriate1))

File_norm_totorg_mdom <- M_t_analyte_withIS_mdom %>% 
  group_by(r_date) %>% 
  summarise(vol_normnorm_total = sum(vol_is_normnorm), vol_rawnorm_total = sum(vol_is_rawnorm))

File_norm_totorg %>% 
  ggplot(aes(x = r_date, y = vol_rawnorm_total))+
  geom_point()

File_norm_totorg %>% 
  ggplot(aes(x = r_date, y = vol_normnorm_total))+
  geom_point()

M_t_analyte_withIS_mdom <- M_t_analyte_withIS_mdom %>% 
  left_join(File_norm_totorg) %>% 
  mutate(vol_is_normnorm_totorgnorm = vol_is_normnorm/vol_normnorm_total)


```


```{r, fig.width=7, fig.height=7}
btz_info <- read_csv("Benzothiazoles_Combined_info.csv")

btzdatemin <- min(bt_sum_bloom3$r_date)
btzdatemax <- max(bt_sum_mdom$r_date)

M_t_analyte_withIS_mdom.btz <- M_t_analyte_withIS_mdom %>% 
  left_join(btz_info, by = c("Compound.Name"= "MDOM_name")) %>% 
  filter(!is.na(NIST_Name)) %>% 
  mutate(My_Name = factor(My_Name,
                levels = c("2(3H)-Benzothiazolone", "Benzothiazole", "3-Methyl-3H-benzothiazol-2-one", "4-Ethyl-5-methylthiazole", "2-(Methylmercapto)benzothiazole", "R-Benzothiazole 1", "Benzothiazole, 2-phenyl- (2)", "5,1-Benzothiazepine-2-one, 3-acetylamino-"))) %>% 
  mutate(r_date_day = date(r_date))

just_btz_mdom_selected <- M_t_analyte_withIS_mdom.btz %>% 
  mutate(amt = vol_is_normnorm) %>% 
  filter(r_date_day == "2019-07-24"| r_date_day == "2019-08-02") %>% 
  dplyr::select(My_Name, r_date_day, water_sol_mg_L, amt, btz_colors) %>% 
  mutate(date_type_factor = paste(r_date_day, "MDOM", sep = " ")) %>% 
  filter(!is.na(My_Name)) %>% 
  filter(!is.na(water_sol_mg_L))


btz_colors_mdom <- btz_info %>% 
  filter(in_mdom == 1)

btz_colors_ssa <- btz_info %>% 
  filter(in_SSA == 1)



M_t_analyte_withIS_mdom.btz %>% 
  ggplot(aes(x = r_date, y = Volume, color = My_Name, fill = log(water_sol_mg_L), order = as.numeric(My_Name)))+
  geom_col(position = "fill", size = 1)+
  scale_fill_gradient(low = "white", high = "black", limits = c(0,8))+
  scale_colour_manual(values = btz_colors_mdom$btz_colors) +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin(), legend.text=element_text(size=8))+
    labs(color="", fill="log(Solubility)")+
  guides(color=guide_legend(nrow=3,byrow=TRUE))+
  ggtitle("Benzothiazoles in MDOM")+
  ylab("Fraction Organic Btz Signal")+
  xlab("")+
  xlim(btzdatemin, btzdatemax)

M_t_analyte_withIS_mdom.btz %>% 
  ggplot(aes(x = r_date, y = Volume, color = My_Name, fill = log(water_sol_mg_L)))+
  geom_col(position = "stack", size = 1)+
  scale_fill_gradient(low = "white", high = "black", limits = c(0,8))+
  scale_colour_manual(values = btz_colors_mdom$btz_colors) +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin(), legend.text=element_text(size=8))+
    labs(color="", fill="log(Solubility)")+
  guides(color=guide_legend(nrow=3,byrow=TRUE))+
  ggtitle("Benzothiazoles in MDOM")+
  ylab("Benzothiazole Signal")+
  xlab("")+
  xlim(btzdatemin, btzdatemax)

M_t_analyte_withIS.btz <- M_t_analyte_withIS %>% 
  left_join(btz_info, by = c("Compound.Name"= "SSA_name")) %>% 
  filter(!is.na(NIST_Name))%>% 
  mutate(My_Name = factor(My_Name,
                levels = c("2(3H)-Benzothiazolone", "Benzothiazole", "2-Benzothiazolamine, N-ethyl-", "2-(Methylmercapto)benzothiazole", "R-Benzothiazole 1", "R-Benzothiazole 2", "R-Benzothiazole 3", "R-Benzothiazole 4", "R-Benzothiazole 5", "R-Benzothiazole 6", "Benzothiazole, 2-phenyl- (1)", "2-o-Tolylbenzothiazole", "1,3-Di(2-benzothiazolyl)-\n1,3-bis(mercaptomethyl)-urea", "3-Ethylbenzothiazolin-2-thione"))) %>% 
  mutate(r_date_day = date(r_date))

just_btz_ssa_selected <- M_t_analyte_withIS.btz %>% 
  mutate(amt = vol_is_normnorm_ptnorm) %>% 
  filter(T_O_D == "Day") %>% 
  filter(r_date_day == "2019-07-24"| r_date_day == "2019-08-02") %>% 
  dplyr::select(My_Name, r_date_day, water_sol_mg_L, amt, btz_colors) %>% 
  mutate(date_type_factor = paste(r_date_day, "SSA", sep = " ")) %>% 
  filter(!is.na(My_Name)) %>% 
  filter(!is.na(water_sol_mg_L))




M_t_analyte_withIS.btz %>% 
  ggplot(aes(x = r_date, y = Volume, color = My_Name, fill = log(water_sol_mg_L), order = as.numeric(My_Name)))+
  geom_col(position = "fill", size = 1)+
  scale_fill_gradient(low = "white", high = "black", limits = c(0,8))+
  scale_colour_manual(values = btz_colors_ssa$btz_colors) +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin(), legend.text=element_text(size=8))+
    labs(color="", fill="log(Solubility)")+
  guides(color=guide_legend(nrow=4,byrow=TRUE))+
  ggtitle("Benzothiazoles in SSA")+
  ylab("Fraction Organic Btz Signal")+
  xlab("")+
  xlim(btzdatemin, btzdatemax)

M_t_analyte_withIS.btz %>% 
  ggplot(aes(x = r_date, y = Volume, color = My_Name, fill = log(water_sol_mg_L)))+
  geom_col(position = "stack", size = 1)+
  scale_fill_gradient(low = "white", high = "black", limits = c(0,8))+
  scale_colour_manual(values = btz_colors_ssa$btz_colors) +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin(), legend.text=element_text(size=8))+
    labs(color="", fill="log(Solubility)")+
  guides(color=guide_legend(nrow=4,byrow=TRUE))+
  ggtitle("Benzothiazoles in SSA")+
  ylab("Fraction Organic Btz Signal")+
  xlab("")+
  xlim(btzdatemin, btzdatemax)


btz_both_ts <- M_t_analyte_withIS.btz %>% 
  full_join(M_t_analyte_withIS_mdom.btz, by = c("r_date", "My_Name")) 
  

btz_both <- rbind(just_btz_mdom_selected, just_btz_ssa_selected) 

btz_both <- btz_both %>% 
  mutate(My_Name = factor(My_Name, levels = c("2(3H)-Benzothiazolone", "Benzothiazole", "3-Methyl-3H-benzothiazol-2-one", "4-Ethyl-5-methylthiazole", "2-Benzothiazolamine, N-ethyl-", "2-(Methylmercapto)benzothiazole", "R-Benzothiazole 1", "R-Benzothiazole 2", "R-Benzothiazole 3", "R-Benzothiazole 4", "R-Benzothiazole 5", "R-Benzothiazole 6", "Benzothiazole, 2-phenyl- (1)", "Benzothiazole, 2-phenyl- (2)", "2-o-Tolylbenzothiazole", "1,3-Di(2-benzothiazolyl)-\n1,3-bis(mercaptomethyl)-urea", "3-Ethylbenzothiazolin-2-thione"))) %>% 
  filter(!is.na(My_Name)) %>% 
  filter(!is.na(water_sol_mg_L))




btz_both %>% 
  ggplot(aes(x = date_type_factor, y = amt, color = My_Name, fill = log(water_sol_mg_L), order = as.numeric(My_Name)))+
  geom_col(position = "fill", size = 1, width = .2)+
  scale_fill_gradient(low = "white", high = "black", limits = c(0,8))+
  scale_colour_manual(values = btz_info$btz_colors) +
  theme(axis.text.x = element_text(angle = -45, vjust = 0, hjust=.1))+
    labs(color="", fill="log(Solubility)")+
  ggtitle("Benzothiazoles in MDOM and SSA")+
  ylab("Fraction Organic Btz Signal")+
  xlab("")

btz_info %>% 
  ggplot(aes(x = NIST_Name, y = water_sol_mg_L, color = My_Name))+
  geom_col()+ 
  scale_colour_manual(values = btz_info$btz_colors) +
  theme(legend.position = "bottom", legend.box="vertical", legend.margin=margin(), legend.text=element_text(size=8))+
    labs(color="", fill="log(Solubility)")+
  guides(color=guide_legend(nrow=4,byrow=TRUE))+
  ggtitle("Benzothiazoles in MDOM and SSA")+
  ylab("Fraction Organic Btz Signal")+
  xlab("")
  
  


```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
